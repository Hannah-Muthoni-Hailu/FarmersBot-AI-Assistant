<FocusTextInput@TextInput>:
    on_touch_down:
        self.focus = True

# reusable background template for a "card"
<CardTemplate@BoxLayout>:
    is_login_mode: False
    toggle_mode: lambda *args: None
    orientation: 'vertical'
    size_hint: (None, None)
    size: (400, 500)
    pos_hint: {'center_x': 0.5, 'center_y': 0.5}
    padding: 10
    canvas.before:
        Color:
            rgba: (96/255), (119/255), (68/255), 1 
        RoundedRectangle:
            size: self.size
            pos: self.pos
            radius: [20, 20, 20, 20] 
    
    # User name input
    Label:
        text: "Enter Username:"
        color: 0, 0, 0, 1
        size_hint_y: None
        height: 30
        text_size: self.size
        halign: 'left'
        valign: 'middle'
        padding_x: 35
   
    FocusTextInput:
        id: username_input
        multiline: False
        focus: True if self.collide_point(*self.parent.to_window(*self.pos)) else False
        size_hint_y: None
        height: 40
        size_hint_x: 0.8
        pos_hint: {'center_x': 0.5}

    # Spacer (pushes the card down)
    Widget:
        size_hint_y: 0.01

    # Password input
    Label:
        text: "Enter Password:"
        color: 0, 0, 0, 1
        size_hint_y: None
        height: 30
        text_size: self.size
        halign: 'left'
        valign: 'middle'
        padding_x: 35
   
    FocusTextInput:
        id: password_input
        multiline: False
        focus: True if self.collide_point(*self.parent.to_window(*self.pos)) else False
        size_hint_y: None
        height: 40
        size_hint_x: 0.8
        pos_hint: {'center_x': 0.5}
    
    Widget:
        size_hint_y: 0.3

    BoxLayout:
        id: input_type_container
        orientation: "vertical"
        size_hint_y: None
        # Use the logic on the parent so the label AND checkboxes hide together
        height: 0 if root.is_login_mode else 70 
        opacity: 0 if root.is_login_mode else 1
        disabled: root.is_login_mode
        spacing: 5

        Label:
            text: "Select your preferred input type"
            color: 0, 0, 0, 1
            size_hint_y: None
            height: 30
            text_size: self.size
            halign: 'left'
            valign: 'middle'
            padding_x: 35

        BoxLayout:
            id: input_type_row
            orientation: "horizontal"
            size_hint_y: None
            height: 40
            size_hint_x: 0.8
            pos_hint: {'center_x': 0.5}

            Label:
                text: "Audio"
                color: 0,0,0,1
            CheckBox:
                id: audio_check
                group: "input"
            Label:
                text: "Text"
                color: 0,0,0,1
            CheckBox:
                id: text_check
                group: "input"

    Widget:
        size_hint_y: 0.01
        
    MDBoxLayout:
        id: dropdown_menu
        orientation: "vertical"
        size_hint_x: 0.8
        size_hint_y: None
        height: 70 if not root.is_login_mode else 0
        pos_hint: {'center_x': 0.5}
        opacity: 1 if not root.is_login_mode else 0
        disabled: root.is_login_mode
        on_touch_down:
            if self.collide_point(*args[1].pos): root.parent.parent.open_subcounty_menu()

        MDTextField:
            id: subcounty_field
            hint_text: "Select subcounty"
            mode: "rectangle"
            readonly: True

    
    # Spacer (pushes the card down)
    Widget:
        size_hint_y: 0.3

    Label:
        text: root.parent.parent.error_message
        color: 1, 0, 0, 1
        size_hint_y: None
        height: 30
        text_size: self.size
        halign: "center"
        valign: "middle"

    
    # Send Button
    Button:
        id: send_button
        text: "SEND"
        size_hint: (0.8, None)
        height: 50
        pos_hint: {'center_x': 0.5}
        background_color: 0,0,0,0
        background_normal: ''
        on_press: 
            root.parent.parent.process_signup() if not root.is_login_mode \
            else root.parent.parent.process_login()
        canvas.before:
            Color:
                rgba: (179/255, 156/255, 77/255, 1)
            RoundedRectangle:
                size: self.size
                pos: self.pos
                radius: [15]
    
    # Spacer
    Widget:
        size_hint_y: 0.1

    Button:
        id: toggle_mode_button
        background_color: 0,0,0,0
        color: 0, 0, 1, 1 # Blue link color
        text:
            "Already have an account? Login here" if not root.is_login_mode \
            else "Don't have an account? Signup here"
        on_release:
            root.toggle_mode()

    # Spacer
    Widget:
        size_hint_y: 0.1

<SignupPage>:
    canvas.before:
        Color:
            rgba: 1, 1, 1, 1
        Rectangle:
            size: self.size
            pos: self.pos

    BoxLayout:
        orientation: "vertical"
        size: root.size
        pos: root.pos

        # Green Horizontal Bar (top)
        BoxLayout:
            id: top_bar
            size_hint_y: None
            height: 50
            canvas.before:
                Color:
                    rgba: (96/255), (119/255), (68/255), 1 
                Rectangle:
                    size: self.size
                    pos: self.pos
        
        # Spacer (pushes the card down)
        Widget:
            size_hint_y: 0.5

        # Green Card (centered)
        CardTemplate:
            id: signup_card
            is_login_mode: root.is_login_mode
            toggle_mode: root.toggle_mode
            # Reuses the CardTemplate style

        # Spacer (pushes the card up)
        Widget:
            size_hint_y: 0.5

<AudioInput>:
    canvas.before:
        Color:
            rgba: 1, 1, 1, 1
        Rectangle:
            size: self.size
            pos: self.pos

    BoxLayout:
        orientation: "vertical"
        size: root.size
        pos: root.pos

        # Green Horizontal Bar (top)
        BoxLayout:
            id: top_bar
            size_hint_y: None
            height: 50
            canvas.before:
                Color:
                    rgba: (96/255), (119/255), (68/255), 1 
                Rectangle:
                    size: self.size
                    pos: self.pos

        RecycleView:
            MDList:
                id: chat_list

        RelativeLayout:
            Button:
                id: record_audio
                text: "Record audio"
                size_hint: (None, None)
                size: (300, 300)
                pos_hint: {'center_x': 0.5, 'center_y': 0.5}
                background_color: 0, 0, 0, 0
                on_press: root.record_audio()
                
                canvas.before:
                    Color:
                        rgba: (96/255), (119/255), (68/255), 1
                    RoundedRectangle:
                        size: self.size
                        pos: self.pos
                        radius: [150]

        Button:
            id: play_response
            text: "Play response"
            size_hint: (0.3, None)
            height: 50
            pos_hint: {'center_x': 0.5}
            disabled: True
            background_color: 0,0,0,0
            background_normal: ''
            on_press: root.play_response()
            canvas.before:
                Color:
                    rgba: (179/255, 156/255, 77/255, 1)
                RoundedRectangle:
                    size: self.size
                    pos: self.pos
                    radius: [15]


        Button:
            id: capture
            text: "CAPTURE"
            size_hint: (0.2, None)
            height: 50
            pos_hint: {'right': 1}
            background_color: 0,0,0,0
            background_normal: ''
            on_press: app.root.current = "textinput"
            canvas.before:
                Color:
                    rgba: (179/255, 156/255, 77/255, 1)
                RoundedRectangle:
                    size: self.size
                    pos: self.pos
                    radius: [15]
            on_press: root.capture_image()

<TextInputScreen>:
    canvas.before:
        Color:
            rgba: 1, 1, 1, 1
        Rectangle:
            size: self.size
            pos: self.pos

    BoxLayout:
        orientation: "vertical"
        size: root.size
        pos: root.pos

        # Green Horizontal Bar (top)
        BoxLayout:
            id: top_bar
            size_hint_y: None
            height: 50
            canvas.before:
                Color:
                    rgba: (96/255), (119/255), (68/255), 1 
                Rectangle:
                    size: self.size
                    pos: self.pos

        RecycleView:
            MDList:
                id: chat_list


        BoxLayout:
            id: input_panel
            orientation: "horizontal"
            size_hint_y: None
            height: 60
            padding: 10
            spacing: 10
            canvas.before:
                Color:
                    rgba: (240/255), (240/255), (240/255), 1 # Light grey background
                Rectangle:
                    size: self.size
                    pos: self.pos

            FocusTextInput:
                id: message_input
                hint_text: "Type your message here..."
                multiline: False
                size_hint_x: 0.8

            Button:
                id: send
                text: "Send"
                size_hint_x: 0.2
                background_color: 0,0,0,0
                canvas.before:
                    Color:
                        rgba: (179/255, 156/255, 77/255, 1)
                    RoundedRectangle:
                        size: self.size
                        pos: self.pos
                        radius: [10]
                on_press: root.send_message()

            Button:
                id: capture
                text: "Capture"
                size_hint_x: 0.2
                background_color: 0,0,0,0
                canvas.before:
                    Color:
                        rgba: (179/255, 156/255, 77/255, 1)
                    RoundedRectangle:
                        size: self.size
                        pos: self.pos
                        radius: [10]

                on_press: root.capture_image()
